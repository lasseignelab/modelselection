# using fullcor object to analyze global gene and variable gene correlations

# prerequisite files:
* sample_master_meta: generated from MetaTable RMD script using the RSE objects for each sample group, which themselves are generated from the DataDownload RMD script.
* all sample group tpm files: the tpm objects will be generated as files if the DataDownload script is run, or can be created by running `x_tpm <- assays(x_rse)$TPM` using an RSE where x is your source of choice
  
load in packages
```{r} 
library(ggplot2)
library(ggfortify)
library(mixOmics)
library(PLSDAbatch)
library(edgeR)
library(matrixStats)
library(pheatmap)
library(rstatix)
library(coin)
library(ggpubr)
```

# read in full correlation object
```{r read in fullcor obj}
sample_master_meta <- readRDS("../data/sample_master_meta.rds")
fullcor <- readRDS("../data/fullcor.rds")
```

# first, make subsets of correlation matrix, to brain samples, then to just PDX and just CL
```{r subset fullcor to just brain}
# subset for brain
brain_samples <- sample_master_meta[grep("Brain", sample_master_meta$tissue_coerced),]$rse_sampname
fullcor_brain <- fullcor[rownames(fullcor) %in% brain_samples, colnames(fullcor) %in% brain_samples]

# samples that are tumor GBM
gbm_samples <- sample_master_meta[grep("Glioblastoma Multiforme", sample_master_meta$disease),]$rse_sampname

gbm_tis_samples <- gbm_samples[gbm_samples %in% sample_master_meta[sample_master_meta$origin == "Tumor Tissue",]$rse_sampname]

# samples that are tumor brain
bt_samples <- sample_master_meta[grep("Brain Cancer", sample_master_meta$disease_coerced),]$rse_sampname

# samples that are control brain
bcon_samples <- sample_master_meta[grep("NonDisease Brain", sample_master_meta$disease_coerced),]$rse_sampname

# subset master sample metadata to brain
sample_brain_meta <- data.frame(sample_master_meta[sample_master_meta$rse_sampname %in% brain_samples,])

# make cell line correlation matrix
cell_line_samples <- sample_master_meta[grep("Cell Line", sample_master_meta$origin),]$rse_sampname
cell_line_samples <- cell_line_samples[cell_line_samples %in% brain_samples]
cell_line_gbm_samples <- cell_line_samples[cell_line_samples %in% sample_brain_meta[grep("Grade Iv|Glioblastoma", sample_brain_meta$disease),]$rse_sampname]
fullcor_brain_cl <- fullcor_brain[,colnames(fullcor_brain) %in% cell_line_samples]
fullcor_gbm_cl <- fullcor_brain_cl[,colnames(fullcor_brain_cl) %in% gbm_samples]

# subset sample master metadata to only include GBM cell lines out of all cell lines
cell_line_nongbm_samples <- cell_line_samples[!cell_line_samples %in% cell_line_gbm_samples]
sample_brain_meta <- data.frame(sample_brain_meta[!sample_brain_meta$rse_sampname %in% cell_line_nongbm_samples,])

# make pdx correlation matrix
pdx_samples <- sample_master_meta[grep("PDX", sample_master_meta$origin),]$rse_sampname
pdx_samples <- pdx_samples[pdx_samples %in% brain_samples]
fullcor_gbm_pdx <- fullcor_brain[, colnames(fullcor_brain) %in% pdx_samples]
```

# read in TPM
```{r read tpm}
ccle_tpm <- readRDS("../data/recount3/tpm/ccle_tpm.rds")
hpa_c_tpm <- readRDS("../data/recount3/tpm/hpa_c_tpm.rds")
tcga_tpm <- readRDS("../data/recount3/tpm/tcga_tpm.rds")
gtex_tpm <- readRDS("../data/recount3/tpm/gtex_tpm.rds")
hpa_t_tpm <- readRDS("../data/recount3/tpm/hpa_t_tpm.rds")
pdx_tpm <- readRDS("../data/recount3/tpm/pdx_tpm.rds")
```

# PCA
```{r pca}
# make one big tpm object for PC generation
## I would just make the full tpm obj then subset but it's too big for local, takes forever
gtex_tpm_b <- gtex_tpm[,colnames(gtex_tpm) %in% brain_samples]
tcga_tpm_b <- tcga_tpm[,colnames(tcga_tpm) %in% brain_samples]
hpa_t_tpm_b <- hpa_t_tpm[,colnames(hpa_t_tpm) %in% brain_samples]
ccle_tpm_b <- ccle_tpm[,colnames(ccle_tpm) %in% brain_samples]
ccle_tpm_gbm <- ccle_tpm[,colnames(ccle_tpm) %in% cell_line_gbm_samples]
hpa_c_tpm_b <- hpa_c_tpm[,colnames(hpa_c_tpm) %in% brain_samples]

brain_tpm <- cbind(tcga_tpm_b, gtex_tpm_b, hpa_t_tpm_b, ccle_tpm_gbm, hpa_c_tpm_b, pdx_tpm) # with just GBM PDX and CL samples
brain_tpm <- brain_tpm[,colnames(brain_tpm) %in% sample_brain_meta$rse_sampname]
 
# need to pre-filter for PCA to work 
## try filterByExpr in edgeR
keep <- filterByExpr(brain_tpm, min.count = 1, min.total.count = 1)
brain_tpm_filt <- brain_tpm[keep,] # only about 5K genes unless I default parameter stringency, this now leaves 17K

# now format for prcomp to compute PC's
#brain_tpm_meta <- data.frame(t(brain_tpm_filt))
#brain_tpm_meta$origin <- sample_brain_meta[,2]
#brain_pcares <- prcomp(t(brain_tpm_filt))

# start with autoplot to find PCs with significant separation
#autoplot(brain_pcares, data = brain_tpm_meta, colour = "origin")
#autoplot(brain_pcares, data = brain_tpm_meta, colour = "origin", x = 2, y = 3)

# additionally plot each cell line type
## using autoplot because too many options for density rug plot
## fix some metadata for cell line type first
## NAs in cell_line col mean exclude NAs then subset
#sample_brain_meta[!is.na(sample_brain_meta$cell_line) & sample_brain_meta$cell_line=="u251mg_",]$cell_line <- "u251mg" ##removed when filtering for GBM-derived CL's
#sample_brain_meta[!is.na(sample_brain_meta$cell_line) & sample_brain_meta$cell_line=="shsy5y_",]$cell_line <- "shsy5y" #removed when filtering for GBM-derived CL's

# need to make and re-filt tpm matrix for just cell lines
#gbm_cl_tpm <- brain_tpm_filt[,colnames(brain_tpm_filt) %in% cell_line_gbm_samples]

#keep <- filterByExpr(gbm_cl_tpm, min.count = 1, min.total.count = 1)
#gbm_cl_tpm_filt <- gbm_cl_tpm[keep,]

#gbm_cl_pcares <- prcomp(t(gbm_cl_tpm_filt))

# adding cell line info
#gbm_cl_pca_meta <- data.frame(t(gbm_cl_tpm_filt))
#gbm_cl_pca_meta$cl <- sample_brain_meta[sample_brain_meta$rse_sampname %in% cell_line_gbm_samples,]$cell_line

# make pca visual
#autoplot(gbm_cl_pcares, data = gbm_cl_pca_meta, colour = "cl")
```

# now the fancy PCAs
## adjust Scatter_Density fun
```{r}
Scatter_Density_adj <- function (object, batch = NULL, trt = NULL, xlim = NULL, ylim = NULL, 
  color.set = NULL, batch.legend.title = "Batch", trt.legend.title = "Treatment", 
  density.lwd = 0.2, title = NULL, title.cex = 1.5, legend.cex = 0.7, 
  legend.title.cex = 0.75, y.axis.cex = 0.8, x.axis.cex = 0.8, point.size = 1.5, axis.text.cex = 0.6) 
{
  data = as.data.frame(object[["variates"]][["X"]])
  expl.var = object[["prop_expl_var"]][["X"]]
  if (is.null(batch)) {
    batch <- batch
  }
  else {
    batch <- as.factor(batch)
  }
  if (is.null(trt)) {
    trt <- trt
  }
  else {
    trt <- as.factor(trt)
  }
  if (is.null(color.set)) {
    color.set = color.mixo(seq_len(10))
  }
  else {
    color.set = color.set
  }
  pMain <- ggplot(data = data, aes(x = data[, 1], y = data[, 
    2], colour = batch, shape = trt)) + geom_point(size = point.size) + xlab(paste0("PC1: ", 
    round(as.numeric(expl.var[1]) * 100), "% expl.var")) + 
    ylab(paste0("PC2: ", round(as.numeric(expl.var[2]) * 
      100), "% expl.var")) + scale_shape_manual(values = c(1, 
    19, 2, 17, 4)) + scale_color_manual(values = color.set) + 
    theme_bw() + labs(colour = batch.legend.title, shape = trt.legend.title) + 
    scale_x_continuous(limits = xlim) + scale_y_continuous(limits = ylim) + 
    theme(legend.position = "right", legend.box = "horizontal", 
      legend.direction = "vertical", legend.key.height = unit(0.2, 
        "cm"), legend.key.width = unit(0.1, "cm"), legend.title = element_text(size = rel(legend.title.cex), face = "bold"), 
      legend.spacing.x = unit(0.1, "cm"), legend.spacing.y = unit(0.1, 
        "cm"), legend.text = element_text(size = rel(legend.cex), face = "bold"), axis.title.y = element_text(size = rel(y.axis.cex), face = "bold"), axis.title.x = element_text(size = rel(x.axis.cex), face = "bold"), axis.text = element_text(size = rel(axis.text.cex)))
  xlim.update <- layer_scales(pMain)$x$get_limits()
  ylim.update <- layer_scales(pMain)$y$get_limits()
  pTop <- ggplot(data = data, aes(x = data[, 1], fill = batch, 
    linetype = trt)) + geom_density(size = density.lwd, 
    alpha = 0.5) + ylab("Density") + theme(axis.title.x = element_blank(), 
    axis.title.y = element_text(size = rel(y.axis.cex), face = "bold"), plot.title = element_text(hjust = 0.5, size = rel(title.cex), face = "bold"), axis.line = element_blank(), 
    axis.text = element_blank(), axis.ticks = element_blank(), 
    panel.background = element_blank(), legend.position = "none") + 
    scale_fill_manual(values = color.set) + scale_x_continuous(limits = xlim.update) + 
    labs(title = title)
  pRight <- ggplot(data = data, aes(x = data[, 2], fill = batch, 
    linetype = trt)) + geom_density(size = density.lwd, 
    alpha = 0.5) + coord_flip() + ylab("Density") + theme(axis.title.x = element_text(size = rel(x.axis.cex), face = "bold"), 
    axis.title.y = element_blank(), axis.line = element_blank(), 
    axis.text = element_blank(), axis.ticks = element_blank(), 
    panel.background = element_blank(), legend.position = "none") + 
    scale_fill_manual(values = color.set) + scale_x_continuous(limits = ylim.update)
  if (is.null(batch) && is.null(trt)) {
    legend <- grid.rect(gp = gpar(col = "white"))
  }
  else {
    legend <- get_legend(pMain)
  }
  gridExtra::grid.arrange(pTop, legend, pMain + theme(legend.position = "none"), 
    pRight, ncol = 2, nrow = 2, widths = c(6, 2), heights = c(2, 
      6))
}

```

```{r rug plot}
pca_brain <- pca(t(brain_tpm_filt), ncomp = 3, scale = TRUE)
saveRDS(pca_brain, "../data/pca_brain.rds")

# making origin factor
brain_meta_sub <- matrix(sample_brain_meta[,"origin"])
rownames(brain_meta_sub) <- sample_brain_meta$rse_sampname
#brain_meta_sub[brain_meta_sub == "NonDisease Tissue",] <- "Non-Disease Tissue"
brain_fact_origin <- factor(brain_meta_sub)

brain_meta_sub <- matrix(sample_brain_meta[,"source"])
rownames(brain_meta_sub) <- sample_brain_meta$rse_sampname
brain_fact_cohort <- factor(brain_meta_sub)

# making visual
## by just origin type
colorset <- rainbow(4)
png("../plots/GBM_pca_origintype.png", width = 2000, height = 1000)
Scatter_Density_adj(object = pca_brain, batch = brain_fact_origin, color.set = colorset, batch.legend.title = "Origin Type", legend.cex = 4, legend.title.cex = 4.4, title.cex = 3.2, y.axis.cex = 5, x.axis.cex = 5, point.size = 5, axis.text.cex = 4)
dev.off() 

# by data source
colorset <- rainbow(6)
Scatter_Density(object = pca_brain, batch = brain_fact_cohort, color.set = colorset, batch.legend.title = "Data Cohort")
Scatter_Density(object = pca_brain, batch = brain_fact_cohort, color.set = colorset, trt = brain_fact_origin, batch.legend.title = "Data Cohort", trt.legend.title = "Data Type")

# I kinda want to see what the split in control tissue is led by
brain_meta_sub <- matrix(sample_brain_meta$sex)
rownames(brain_meta_sub) <- sample_brain_meta$rse_sampname
brain_fact_sex <- factor(brain_meta_sub)

Scatter_Density(object = pca_brain, batch = brain_fact_sex, color.set = colorset, batch.legend.title = "Origin Type")

# clean env
rm(brain_meta_sub, brain_fact_cohort, brain_fact_origin)
#rm(pca_brain)# be careful if you still need this, obj takes a while to generate
gc()
```

# next, compare median correlation to GBM tissue, all brain tumor tissue, and brain control tissue
```{r}
# for cell lines
## all
#fullcor_gbm_cl_sub <- data.frame(GBM = colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% gbm_samples,])))
#fullcor_gbm_cl_sub$BT <- colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% bt_samples,]))
#fullcor_gbm_cl_sub$BCon <- colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% bcon_samples,]))
#rownames(fullcor_gbm_cl_sub) <- colnames(fullcor_gbm_cl)
#gbm_cl_cor <- colMedians(as.matrix(fullcor_gbm_cl_sub)) ##### SAME CODE AS BELOW VVV #####

## just GBM
fullcor_gbm_cl_sub <- data.frame(GBM = colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% gbm_samples,])))
fullcor_gbm_cl_sub$BT <- colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% bt_samples,]))
fullcor_gbm_cl_sub$BCon <- colMedians(as.matrix(fullcor_gbm_cl[rownames(fullcor_gbm_cl) %in% bcon_samples,]))
rownames(fullcor_gbm_cl_sub) <- colnames(fullcor_gbm_cl)
gbm_cl_cor <- colMedians(as.matrix(fullcor_gbm_cl_sub))

# for pdx
fullcor_gbm_pdx_sub <- data.frame(GBM = colMedians(as.matrix(fullcor_gbm_pdx[rownames(fullcor_gbm_pdx) %in% gbm_samples,])))
fullcor_gbm_pdx_sub$BT <- colMedians(as.matrix(fullcor_gbm_pdx[rownames(fullcor_gbm_pdx) %in% bt_samples,]))
fullcor_gbm_pdx_sub$BCon <- colMedians(as.matrix(fullcor_gbm_pdx[rownames(fullcor_gbm_pdx) %in% bcon_samples,]))
rownames(fullcor_gbm_pdx_sub) <- colnames(fullcor_gbm_pdx)
gbm_pdx_cor <- colMedians(as.matrix(fullcor_gbm_pdx_sub))

#View(data.frame(GBM_pdx = gbm_pdx_cor, GBM_cl = gbm_cl_cor, BRAIN_cl = gbm_cl_cor, row.names = c("GBM_tis", "BT_tis", "BCon_tis"))) #### gbm_cl_cor used twice ####

# save then clear objects
saveRDS(gbm_cl_cor, "../data/gbm_cellline_cor.rds")
saveRDS(gbm_pdx_cor, "../data/gbm_pdx_cor.rds")
#rm(fullcor_gbm_cl_sub, fullcor_gbm_pdx_sub, gbm_cl_cor, brain_pdx_cor)
```

Correlation metrics:
* to just GBM tissues: 0.845 all cell lines, 0.848 just gbm cell lines, 0.867 pdx
* to all brain tumor tissues: 0.833 all cell lines, 0.836 just gbm cell lines, 0.86 pdx
* to all brain control tissues: 0.811 all cell lines, 0.814 just gbm cell lines, 0.836 pdx

# how many of each correlate highest with tissue of origin?
```{r} 
cor_dismatch_res_all <- readRDS("../data/recount3/corres/cor_dismatch_res_all.rds")
cor_bestmatch <- cor_dismatch_res_all[["alltoptissue"]]
cor_bestmatch_cl <- cor_bestmatch[cor_bestmatch$sample %in% cell_line_gbm_samples,]
length(cor_bestmatch_cl[cor_bestmatch_cl$samp_origin == cor_bestmatch_cl$res_top_first,]$sample) 
View(table(cor_bestmatch_cl[cor_bestmatch_cl$samp_origin != cor_bestmatch_cl$res_top_first,]$res_top_first))
cor_bestmatch_pdx <- cor_bestmatch[cor_bestmatch$sample %in% pdx_samples,]
length(cor_bestmatch_pdx[cor_bestmatch_pdx$samp_origin == cor_bestmatch_pdx$res_top_first,]$sample) 

# clear objects
#rm(cor_dismatch_res_all, cor_bestmatch, cor_bestmatch_cl, cor_bestmatch_pdx)
```

1 of 27 cell lines most closely correlated with brain cancer
64 of 64 pdxs most closely correlated with brain cancer

other correlations for cell lines:
* cervical cancer = 1
* NonDisease adrenal gland = 20
* NonDisease blood vessel = 3
* NonDisease uterus = 2
* pleural cancer = 2
* skin cancer = 5
* soft tissue cancer = 1

# heatmaps
```{r heatmaps}
# first, heatmap of all tissue to all model

# annotating rows and columns
annotation_col <- data.frame(Model = sample_brain_meta[grep("Cell Line|PDX", sample_brain_meta$origin),]$origin)
rownames(annotation_col) <- sample_brain_meta[grep("Cell Line|PDX", sample_brain_meta$origin),]$rse_sampname
annotation_row <- data.frame(Tissue = sample_brain_meta[grep("Tumor Tissue|NonDisease Tissue", sample_brain_meta$origin),]$origin)
rownames(annotation_row) <- sample_brain_meta[grep("Tumor Tissue|NonDisease Tissue", sample_brain_meta$origin),]$rse_sampname
annotation_row$Tissue[annotation_row$Tissue == "NonDisease Tissue"] #<- "Non-Disease Tissue" #updated in metatable now
colnames(annotation_row) <- "Brain Tissue Type"

pheatmap(fullcor_brain, annotation_col = annotation_col, annotation_row = annotation_row, show_rownames = FALSE, show_colnames = FALSE, color = colorRampPalette(c("yellow", "red"))(200))

# now heatmap of median for each subset
## making cor matrix subsets
fullcor_gbm <- fullcor_brain[, colnames(fullcor_brain) %in% rownames(annotation_col)] #correlations of brain to GBM-derived CL and PDX samples
gbmcor <- fullcor_gbm[rownames(fullcor_gbm) %in% gbm_samples,]
btcor <- fullcor_gbm[rownames(fullcor_gbm) %in% bt_samples,]
bccor <- fullcor_gbm[rownames(fullcor_gbm) %in% bcon_samples,]

## now take median across cols (tissues)
gbmcor_tissub <- colMedians(gbmcor)
btcor_tissub <- colMedians(btcor)
bccor_tissub <- colMedians(bccor)

## make all one object
hm_rm <- data.frame(GBM_Tissue = gbmcor_tissub, Brain_Tum_Tissue = btcor_tissub, Brain_Control_Tissue = bccor_tissub)
rownames(hm_rm) <- colnames(gbmcor)
saveRDS(cbind(annotation_col, hm_rm), "../data/gbm_modelsandtissues_cor.rds")

# annotation colors
ann_colors <- list(Model = c('Cell Line' = "#ff9288", 'PDX' = "#01dae0"))

## hm time
ph <- pheatmap(hm_rm, annotation_row = annotation_col, show_rownames = F, angle_col = 45, fontsize = 43, labels_col = c("GBM Tumor", "All Brain Tumor", "Brain Non-Disease"), color = colorRampPalette(c("yellow", "red"))(200), annotation_colors = ann_colors)
ph$gtable$grobs[[1]]$gp <- gpar(lwd = 4)
ph$gtable$grobs[[2]]$gp <- gpar(lwd = 4)
png("../plots/JUSTGBM_hm_brainsubs.png", width = 1800, height = 2200)
grid.newpage()
grid.draw(ph$gtable)
dev.off()
```

# violin plot
```{r}
# let's focus in on A-172, u87mg, u251mg, and shsy5y for cell lines
# first, pulling the selected cell lines + pdx's from fullcor, then making sure they're ordered
brain_clsub_cor <- fullcor[,colnames(fullcor) %in% c(cell_line_gbm_samples, pdx_samples)]
clsub_pdx_samples <- c(cell_line_gbm_samples, pdx_samples)

# splitting into tum and con
brain_clsub_tum <- brain_clsub_cor[rownames(brain_clsub_cor) %in% bt_samples,]
brain_clsub_tum_med <- colMedians(brain_clsub_tum)
brain_clsub_con <- brain_clsub_cor[rownames(brain_clsub_cor) %in% bcon_samples,]
brain_clsub_con_med <- colMedians(brain_clsub_con)

# making tissue vector
origin <- c(rep("Cell Line", length(cell_line_gbm_samples)), rep("PDX", length(pdx_samples)))
cl_type <- sample_brain_meta[sample_brain_meta$rse_sampname %in% clsub_pdx_samples,]$cell_line

cl_pdx_violin <- data.frame(tum_med_cor = brain_clsub_tum_med, con_med_cor = brain_clsub_con_med, type = origin, cl = cl_type)
rownames(cl_pdx_violin) <- clsub_pdx_samples


# Basic violin plot
ggplot(cl_pdx_violin, aes(x=type, y=con_med_cor)) + 
  geom_violin(aes(color = type)) + geom_jitter(shape=16, position=position_jitter(0.2), aes(color = type)) + guides(color = "none") + labs(x = "Model Type", y = "Median Correlation of Model to Brain Non-Disease Tissue") + theme(text = element_text(face = "bold"), legend.text = element_text(size = 16), legend.title = element_text(size = 18), axis.title = element_text(size = 14), axis.text = element_text(size = 15)) + geom_signif(comparisons = list(c("Cell Line", "PDX")), test = "wilcox.test", map_signif_level = TRUE)
ggsave(filename = "../plots/tags_violin/fullgenesvio_brainclvspdx_con.png", width = 5, height = 6)

#con_violin_alt <- ggplot(cl_pdx_violin, aes(x=type, y=con_med_cor, color = type)) + 
#  geom_violin() + geom_jitter(shape=16, position=position_jitter(0.2)) + guides(color = "none") + labs(x = "Model Type", y = "Median #Correlation of Model Sample to Brain Non-Disease Tissue") + ylim(0.5,0.9) + guides(color = "none") # alt with scale difference for fig 3

ggplot(cl_pdx_violin, aes(x=type, y=tum_med_cor)) + 
  geom_violin(aes(color = type)) + geom_jitter(shape=16, position=position_jitter(0.2), aes(color = type)) + guides(color = "none") + labs(x = "Model Type", y = "Median Correlation of Model to Brain Tumor Tissue") + theme(text = element_text(face = "bold"), legend.text = element_text(size = 16), legend.title = element_text(size = 18), axis.title = element_text(size = 14), axis.text = element_text(size = 15)) + geom_signif(comparisons = list(c("Cell Line", "PDX")), test = "wilcox.test", map_signif_level = TRUE)
ggsave(filename = "../plots/tags_violin/fullgenesvio_brainclvspdx_tum.png", width = 5, height = 6)

#tum_violin_alt <- ggplot(cl_pdx_violin, aes(x=type, y=tum_med_cor, color = type)) + 
#  geom_violin() + geom_jitter(shape=16, position=position_jitter(0.2)) + guides(color = "none") + labs(x = "Model Type", y = "Median #Correlation of Model Sample to Brain Tumor Tissue") + ylim(0.5,0.9) + guides(color = "none") # alt with scale difference for fig 3
```

# Wilcoxon rank sum test on these two groups
```{r}
# Question : Is there any significant difference between pdx and cell line median correlation to matched tissue?
# computation - tumor
stat.test <- cl_pdx_violin %>% 
  rstatix::wilcox_test(tum_med_cor ~ type) %>%
  add_significance()
stat.test

# effect size
cl_pdx_violin %>% wilcox_effsize(tum_med_cor ~ type)

# report
stat.test <- stat.test %>% add_xy_position(x = "group")


#tum_violin + 
#  stat_pvalue_manual(stat.test, tip.length = 0) +
#  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
#
#tum_violin_alt + 
#  stat_pvalue_manual(stat.test, tip.length = 0) +
#  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
#ggsave(filename = "../plots/tags_violin/fullgenesvio_brainclvspdx_tum.png", 
          #width = 5, height = 6)

# again for control
# computation - tumor
stat.test <- cl_pdx_violin %>% 
  rstatix::wilcox_test(con_med_cor ~ type) %>%
  add_significance()
stat.test

# effect size
cl_pdx_violin %>% wilcox_effsize(con_med_cor ~ type)

# report
stat.test <- stat.test %>% add_xy_position(x = "group")
#con_violin + 
#  stat_pvalue_manual(stat.test, tip.length = 0) +
#  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
#
#con_violin_alt + 
#  stat_pvalue_manual(stat.test, tip.length = 0) +
#  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
#ggsave(filename = "../plots/tags_violin/fullgenesvio_brainclvspdx_con.png", 
          #width = 5, height = 6)
```

# violin plot how the two groups each recapitulated across tissue types
```{r violin across tissues}
# read in object with each model sample's median corr to each tissue
cor_dismatch_res_all <- readRDS("../data/recount3/corres/cor_dismatch_res_all.rds")
cor_dismatch_res_bytis <- cor_dismatch_res_all$fullcorapp

# split by model
cor_dismatch_res_bytis_cl <- cor_dismatch_res_bytis[rownames(cor_dismatch_res_bytis) %in% cell_line_gbm_samples,]
cor_dismatch_res_bytis_pdx <- cor_dismatch_res_bytis[rownames(cor_dismatch_res_bytis) %in% pdx_samples,]

# split into cancer, control
cor_dismatch_res_cantis_cl <- cor_dismatch_res_bytis_cl[,grep("Cancer", colnames(cor_dismatch_res_bytis_cl))]
cor_dismatch_res_cantis_pdx <- cor_dismatch_res_bytis_pdx[,grep("Cancer", colnames(cor_dismatch_res_bytis_pdx))]

cor_dismatch_res_contis_cl <- cor_dismatch_res_bytis_cl[,grep("NonDisease", colnames(cor_dismatch_res_bytis_cl))]
cor_dismatch_res_contis_pdx <- cor_dismatch_res_bytis_pdx[,grep("NonDisease", colnames(cor_dismatch_res_bytis_pdx))]

# make big objects for split violin
cor_dismatch_res_cantis <- rbind(cor_dismatch_res_cantis_cl, cor_dismatch_res_cantis_pdx)
cor_dismatch_res_contis <- rbind(cor_dismatch_res_contis_cl, cor_dismatch_res_contis_pdx)

# now need to remake object to be compatible (length-wise data instead of width-wise)
cor_can_all_tis <- "x"
for(i in 1:ncol(cor_dismatch_res_cantis)){
  cor_can_all_tis <- rbind(cor_can_all_tis, cor_dismatch_res_cantis[i])
  if(i != length(cor_dismatch_res_cantis)){
    colnames(cor_can_all_tis) <- colnames(cor_dismatch_res_cantis[i+1])
  }
}
cor_can_all_tis <- cor_can_all_tis[-1,]

tissue <- colnames(cor_dismatch_res_cantis)
tissue <- stringr::str_remove_all(tissue, " Cancer")
tissue_rep <- rep(tissue[1], 100)
for(i in tissue[-1]){
  tissue_rep <- c(tissue_rep, rep(i, 100))
}

clpdx <- c(rep("Cell Line", 35), rep("PDX", 65))
clpdx <- rep(clpdx, length(tissue))

cor_dismatch_cantis_long <- data.frame(cor = cor_can_all_tis, tissue = tissue_rep, Model = clpdx)
cor_dismatch_cantis_long$cor <- as.numeric(cor_dismatch_cantis_long$cor)

# two objects for data
cor_dismatch_cantis_long_cl <- cor_dismatch_cantis_long[cor_dismatch_cantis_long$Model == "Cell Line",]
cor_dismatch_cantis_long_pdx <- cor_dismatch_cantis_long[cor_dismatch_cantis_long$Model == "PDX",]


######

# do it again for control tissue

# now need to remake object to be compatible (length-wise data instead of width-wise)
cor_con_all_tis <- "x"
for(i in 1:ncol(cor_dismatch_res_contis)){
  cor_con_all_tis <- rbind(cor_con_all_tis, cor_dismatch_res_contis[i])
  if(i != 34){
    colnames(cor_con_all_tis) <- colnames(cor_dismatch_res_contis[i+1])
  }
}
cor_con_all_tis <- cor_con_all_tis[-1,]

tissue <- colnames(cor_dismatch_res_contis)
tissue <- stringr::str_remove_all(tissue, "NonDisease ")
tissue_rep <- rep(tissue[1], 100)
for(i in tissue[-1]){
  tissue_rep <- c(tissue_rep, rep(i, 100))
}

clpdx <- c(rep("Cell Line", 35), rep("PDX", 65))
clpdx <- rep(clpdx, length(tissue))

cor_dismatch_contis_long <- data.frame(cor = cor_con_all_tis, tissue = tissue_rep, Model = clpdx)
cor_dismatch_contis_long$cor <- as.numeric(cor_dismatch_contis_long$cor)

# two objects for data
cor_dismatch_contis_long_cl <- cor_dismatch_contis_long[cor_dismatch_contis_long$Model == "Cell Line",]
cor_dismatch_contis_long_pdx <- cor_dismatch_contis_long[cor_dismatch_contis_long$Model == "PDX",]
```

# geom_split_violin fun
```{r}
source("../scripts/functions/geom_split_violin.R")
```

```{r plot}
ggplot(cor_dismatch_cantis_long, aes(tissue, cor, fill = Model)) + geom_split_violin() + labs(x = "", y = "") + theme(axis.text.x = element_text(angle = 45, hjust=1, face = "bold")) + theme(text = element_text(face = "bold"), legend.text = element_text(size = 18, face = "bold"), legend.title = element_text(size = 20, face = "bold"), axis.text = element_text(size = 18, face = "bold")) + ylim(0.7, 0.9) # to add significance and axis labels later
ggsave(filename = "../plots/vio_braincltoeachtum.png", 
          width = 18, height = 7)

range(cor_dismatch_cantis_long_cl$cor)
range(cor_dismatch_cantis_long_pdx$cor)

ggplot(cor_dismatch_contis_long, aes(tissue, cor, fill = Model)) + geom_split_violin() + labs(x = "", y = "") + theme(axis.text.x = element_text(angle = 45, hjust=1, face = "bold")) + theme(text = element_text(face = "bold"), legend.text = element_text(size = 18, face = "bold"), legend.title = element_text(size = 20, face = "bold"), axis.text = element_text(size = 18, face = "bold")) + ylim(0.7, 0.9) # to add significance and axis labels later
ggsave(filename = "../plots/vio_braincltoeachcon.png", 
          width = 18, height = 7)
```

```{r}
# Question : Is there any significant difference between pdx and cell line median correlation to EACH tissue?
cor_dismatch_stattest_alltis <- list()
# they have different tissues so I'll do sep loops
for(i in unique(cor_dismatch_cantis_long$tissue)){
  cor_dismatch_stattest_alltis[["can"]][[paste(i)]] <- cor_dismatch_cantis_long[cor_dismatch_cantis_long$tissue == i,] %>%
    rstatix::wilcox_test(cor ~ Model) %>% add_significance()
}

for(i in unique(cor_dismatch_contis_long$tissue)){
  cor_dismatch_stattest_alltis[["con"]][[paste(i)]] <- cor_dismatch_contis_long[cor_dismatch_contis_long$tissue == i,] %>%
    rstatix::wilcox_test(cor ~ Model) %>% add_significance()
}

# add Bonferonni test

for(i in c("can", "con")){
    type <- i
    for(i in names(cor_dismatch_stattest_alltis[[paste(type)]])){
        cor_dismatch_stattest_alltis[[type]][[i]][["bon_p"]] <- p.adjust(cor_dismatch_stattest_alltis[[type]][[i]][["p"]], n = length(names(cor_dismatch_stattest_alltis[[type]])), method = "bonferroni")
        cor_dismatch_stattest_alltis[[type]][[i]][["bon_p.signif"]] <- NA
        if(cor_dismatch_stattest_alltis[[type]][[i]][["bon_p"]] < 0.05){
            cor_dismatch_stattest_alltis[[type]][[i]][["bon_p.signif"]] <- "SIG"
        }else{
            cor_dismatch_stattest_alltis[[type]][[i]][["bon_p.signif"]] <- "INSIG"
        }
    }
}

saveRDS(cor_dismatch_stattest_alltis, "../data/cor_dismatch_stattest_alltis.rds")

# how many tissues were significant?
sig_can <- c()
for(i in names(cor_dismatch_stattest_alltis[["can"]])){
    if(cor_dismatch_stattest_alltis[["can"]][[i]][["bon_p.signif"]] == "SIG"){
          sig_can <- c(sig_can, i)
    }
}
print(paste(length(sig_can), "/", length(names(cor_dismatch_stattest_alltis[["can"]]))))

sig_con <- c()
for(i in names(cor_dismatch_stattest_alltis[["con"]])){
    if(cor_dismatch_stattest_alltis[["con"]][[i]][["bon_p.signif"]] == "SIG"){
          sig_con <- c(sig_con, i)
    }
}
print(paste(length(sig_con), "/", length(names(cor_dismatch_stattest_alltis[["con"]]))))
```

```{r}
sessionInfo()
```
